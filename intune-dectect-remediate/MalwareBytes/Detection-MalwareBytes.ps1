<#
.SYNOPSIS
    Detects whether Malwarebytes is installed on the system.

.DESCRIPTION
    This script checks both 32-bit and 64-bit registry paths for installed applications.
    If any application with "Malwarebytes" in the DisplayName is found, it reports as non-compliant (exit code 0).
    If not found, it reports as compliant (exit code 1), which can trigger remediation in Intune.

.NOTES
    Author: Andrew Welch (aw5qq@virginia.edu)
    
    Run Context : System
    Architecture: 64-bit PowerShell
#>

# ========== CONFIGURATION ==========
$registryPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)
# ===================================

Write-Output "Starting Malwarebytes detection script..."
Write-Output "Checking the following registry paths:"
$registryPaths | ForEach-Object { Write-Output " - $_" }

$malwarebytesFound = $false

foreach ($path in $registryPaths) {
    try {
        Write-Output "Enumerating subkeys under: $path"
        $apps = Get-ChildItem -Path $path -ErrorAction Stop
        foreach ($app in $apps) {
            $appProps = Get-ItemProperty -Path $app.PSPath -ErrorAction SilentlyContinue
            $displayName = $appProps.DisplayName
            $displayVersion = $appProps.DisplayVersion

            if ($displayName) {
                #Write-Output "Found application: $displayName $displayVersion"
                if ($displayName -like "*Malwarebytes*") {
                    Write-Output "Malwarebytes detected: $displayName $displayVersion"
                    $malwarebytesFound = $true
                    break
                }
            }
        }
        if ($malwarebytesFound) { break }
    } catch {
        Write-Warning "Error accessing: ${_}"
    }
}

if ($malwarebytesFound) {
    Write-Output "Detection complete: Malwarebytes is installed."
    exit 0  # Non-compliant
} else {
    Write-Output "Detection complete: Malwarebytes is NOT installed."
    exit 1  # Compliant
}
